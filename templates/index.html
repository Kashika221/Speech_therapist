<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Speech Therapist</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; }
        #recordBtn { padding: 15px 30px; font-size: 18px; cursor: pointer; border-radius: 50px; border: none; background-color: #007bff; color: white; }
        #recordBtn.recording { background-color: #dc3545; animation: pulse 1.5s infinite; }
        .chat-box { margin-top: 20px; text-align: left; border: 1px solid #ddd; padding: 15px; height: 300px; overflow-y: scroll; border-radius: 8px;}
        .message { margin-bottom: 10px; padding: 10px; border-radius: 8px; }
        .user { background-color: #e9ecef; color: #333; }
        .therapist { background-color: #d1e7dd; color: #0f5132; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <h1>üó£Ô∏è AI Speech Therapist</h1>
    <p>Press the button and speak. The AI will listen and respond.</p>

    <button id="recordBtn">Start Recording</button>

    <div class="chat-box" id="chatBox">
        <div class="message therapist"><strong>Therapist:</strong> Hello! I am ready to help you practice. Please press record and introduce yourself.</div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const recordBtn = document.getElementById("recordBtn");
        const chatBox = document.getElementById("chatBox");

        recordBtn.addEventListener("click", async () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                recordBtn.textContent = "Processing...";
                recordBtn.classList.remove("recording");
            } else {
                startRecording();
            }
        });

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                sendAudio(audioBlob);
            };

            mediaRecorder.start();
            recordBtn.textContent = "Stop Recording";
            recordBtn.classList.add("recording");
        }

        async function sendAudio(blob) {
            const formData = new FormData();
            formData.append("file", blob, "input.webm");

            try {
                const response = await fetch("/process-audio", {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();

                if (data.error) {
                    alert("Error: " + data.error);
                    recordBtn.textContent = "Start Recording";
                    return;
                }

                appendMessage("You", data.user_text, "user");
                appendMessage("Therapist", data.ai_text, "therapist");

                const audio = new Audio("data:audio/mp3;base64," + data.audio_base64);
                audio.play();

            } catch (error) {
                console.error(error);
                alert("Something went wrong.");
            } finally {
                recordBtn.textContent = "Start Recording";
            }
        }

        function appendMessage(sender, text, className) {
            const div = document.createElement("div");
            div.className = `message ${className}`;
            div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>